{% extends 'core/base.html' %}
{% load tz %}
{% load custom_tags %}

{% block title %}Student Dashboard{% endblock %}

{% block content %}
<style>
    #student-quizzes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .card {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .card h3 {
        margin-top: 0;
        color: #333;
    }
    .card p {
        margin: 8px 0;
        font-size: 14px;
        color: #555;
    }
    .countdown {
        margin-top: 10px;
        font-weight: bold;
        color: #dc3545;
    }
    .btn {
        display: inline-block;
        margin-top: 10px;
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s;
    }
    .btn:hover {
        background-color: #0056b3;
    }
    .score {
        color: #28a745;
        font-weight: bold;
    }
</style>

<h2>Welcome, <span style="color: #007bff;">{{ request.user.username }}</span></h2>

<h3 style="margin-top: 30px;">Available Quizzes</h3>
<div id="student-quizzes">
    {% for quiz in available_quizzes %}
        <div class="card">
            <h3>{{ quiz.name }}</h3>
            <p>{{ quiz.description }}</p>
            <p><strong>Start Time:</strong> {{ quiz.start_time|localtime }}</p>
            <p><strong>End Time:</strong> {{ quiz.end_time|localtime }}</p>
            <div class="countdown" data-end="{{ quiz.end_time|date:'Y-m-d H:i:s' }}"></div>
            <a href="{% url 'take_quiz' quiz.id %}" class="btn">Take Quiz</a>
        </div>
    {% empty %}
        <p>No quizzes available at the moment.</p>
    {% endfor %}
</div>

<h3 style="margin-top: 30px;">Submitted Quizzes</h3>
<div id="student-quizzes">
    {% for quiz in submitted_quizzes %}
        <div class="card">
            <h3>{{ quiz.name }}</h3>
            <p>{{ quiz.description }}</p>
            <p><strong>Start Time:</strong> {{ quiz.start_time|localtime }}</p>
            <p><strong>End Time:</strong> {{ quiz.end_time|localtime }}</p>
            <p class="score">Score: {{ results|get_item:quiz.id }} / {{ quiz.questions.count }}</p>
        </div>
    {% empty %}
        <p>No quizzes submitted yet.</p>
    {% endfor %}
</div>

<script>
    function startCountdown() {
        const countdowns = document.querySelectorAll('.countdown');
        countdowns.forEach(function (el) {
            const endTimeStr = el.getAttribute('data-end');
            const endTime = new Date(endTimeStr).getTime();

            function updateCountdown() {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance <= 0) {
                    el.innerHTML = "⏰ Quiz has ended.";
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                el.innerHTML = `⏳ <strong>Time Left:</strong> ${hours}h ${minutes}m ${seconds}s`;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        });
    }

    document.addEventListener("DOMContentLoaded", startCountdown);
</script>
{% endblock %}
