{% extends 'core/base.html' %}
{% block title %}Add Question to {{ quiz.name }}{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-gradient bg-primary text-white rounded-top-4">
      <h3 class="mb-0">Add Question to “{{ quiz.name }}”</h3>
    </div>
    <div class="card-body px-4 py-5">
      {% if question_added %}
        <div class="alert alert-success" role="alert">
          ✅ Question successfully added! You can add another below.
        </div>
      {% endif %}

      <!-- Form -->
      <form method="POST" id="question-form" autocomplete="off">
        {% csrf_token %}
        <div class="mb-4">
          <label for="id_question_text" class="form-label">Question</label>
          <input
            type="text"
            id="id_question_text"
            name="question"
            class="form-control form-control-lg rounded-3 shadow-sm border border-secondary-subtle"
            placeholder="Type the question here..."
            required>
        </div>

        <div class="row g-4">
          {% for i in "1234" %}
            <div class="col-md-6">
              <label for="id_option_{{ i }}" class="form-label">Option {{ i }}</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light border-end-0 rounded-start">
                  <input
                    type="radio"
                    name="correct_option"
                    value="{{ forloop.counter0 }}"
                    required
                    style="transform: scale(1.4);"
                  >
                </span>
                <input
                  type="text"
                  id="id_option_{{ i }}"
                  name="options[]"
                  class="form-control border-start-0 rounded-end"
                  placeholder="Enter option {{ i }} text"
                  required>
              </div>
              <div class="form-text">Select radio to mark this as the correct option.</div>
            </div>
          {% endfor %}
        </div>

        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-lg btn-success rounded-pill px-4 shadow-sm">
            <i class="bi bi-plus-circle"></i> Add Question
          </button>
        </div>
      </form>

      <!-- Live Preview -->
      <div class="card border-info mt-5 rounded-3 shadow-sm" id="preview-box" style="display:none;">
        <div class="card-header bg-info text-white rounded-top-3">
          <h5 class="mb-0">Live Preview</h5>
        </div>
        <div class="card-body">
          <h6 id="preview-question" class="fw-bold"></h6>
          <ul class="list-group">
            <li class="list-group-item" id="preview-option1"></li>
            <li class="list-group-item" id="preview-option2"></li>
            <li class="list-group-item" id="preview-option3"></li>
            <li class="list-group-item" id="preview-option4"></li>
          </ul>
          <p class="mt-3"><strong>Correct Answer:</strong>
            <span class="badge bg-success" id="preview-answer"></span>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Script -->
<script>
  const qInput = document.getElementById('id_question_text');
  const optInputs = [
    document.getElementById('id_option_1'),
    document.getElementById('id_option_2'),
    document.getElementById('id_option_3'),
    document.getElementById('id_option_4'),
  ];
  const radios = document.querySelectorAll('input[name="correct_option"]');

  const previewBox = document.getElementById('preview-box');
  const prevQ = document.getElementById('preview-question');
  const prevOpts = [
    document.getElementById('preview-option1'),
    document.getElementById('preview-option2'),
    document.getElementById('preview-option3'),
    document.getElementById('preview-option4'),
  ];
  const prevAns = document.getElementById('preview-answer');

  function updatePreview(){
    const qText = qInput.value.trim();
    if(!qText) {
      previewBox.style.display = 'none';
      return;
    }
    previewBox.style.display = 'block';
    prevQ.innerText = qText;
    optInputs.forEach((inp, i) => {
      prevOpts[i].innerText = inp.value || `Option ${i + 1}`;
      prevOpts[i].classList.remove('list-group-item-success');
    });
    const selected = [...radios].find(r => r.checked);
    const idx = selected ? parseInt(selected.value) : null;
    if (idx !== null) {
      prevOpts[idx].classList.add('list-group-item-success');
      prevAns.innerText = optInputs[idx].value;
    } else {
      prevAns.innerText = '—';
    }
  }

  qInput.addEventListener('input', updatePreview);
  optInputs.forEach(i => i.addEventListener('input', updatePreview));
  radios.forEach(r => r.addEventListener('change', updatePreview));
</script>
{% endblock %}
